<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知车主挪车</title>
    <!-- 引入 SweetAlert2 的 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.5.1/dist/sweetalert2.min.css">
    <!-- 引入页面样式 -->
    <style>
        /* 全局样式 */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        body { 
            font-family: 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #f6d365, #fda085); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            padding: 20px; 
            color: #333;
        }
        .container { 
            background: #fff; 
            padding: 35px 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); 
            max-width: 450px; 
            text-align: center; 
            animation: fadeIn 1s ease-in-out; 
        }
        h1 { 
            font-size: 20px; 
            color: #4a90e2; 
            margin-bottom: 15px; 
        }
        p { 
            font-size: 16px; 
            color: #666; 
            margin-bottom: 20px; 
            line-height: 1.5; 
        }
        .button-group { 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
        button { 
            flex: 1; 
            padding: 18px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            color: #fff; 
        }
        .notify-btn { 
            background: #4caf50; 
        }
        .notify-btn:hover { 
            background: #45a049; 
        }
        .notify-btn:disabled { 
            background: #c8e6c9; 
            color: #777; 
            cursor: not-allowed; 
        }
        .call-btn { 
            background: #2196f3; 
        }
        .call-btn:hover { 
            background: #1e88e5; 
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>通知车主挪车</h1>
        <p>如需通知车主，请点击以下按钮</p>
        <div class="button-group">
            <button id="notify-btn" class="notify-btn">微信通知</button>
            <button class="call-btn" onclick="callOwner()">电话通知</button>
        </div>
    </div>

    <!-- 引入 SweetAlert2 的 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.5.1/dist/sweetalert2.all.min.js"></script>
    <!-- 引入 CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- 脚本 -->
    <script>
        const notifyButton = document.getElementById('notify-btn');

        // 生成随机字符串 (Nonce)
        function generateNonce() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        // 生成签名
        function generateSignature(appToken, nonce, timestamp, secret) {
            const rawString = `appToken=${appToken}&nonce=${nonce}&timestamp=${timestamp}&secret=${secret}`;
            return CryptoJS.SHA256(rawString).toString(CryptoJS.enc.Hex);
        }

        function notifyOwner() {
            const maxAttempts = 3; // 最大允许次数
            const cooldownTime = 10 * 60 * 1000; // 冷却时间，10分钟

            let attempts = JSON.parse(localStorage.getItem('notifyAttempts')) || [];
            const currentTime = Date.now();

            // 过滤出10分钟内的操作记录
            attempts = attempts.filter(attempt => currentTime - attempt < cooldownTime);

            if (attempts.length >= maxAttempts) {
                Swal.fire({
                    icon: 'warning',
                    title: '操作频繁',
                    text: '10分钟内仅允许发送3次通知，请稍后再试！',
                    position: 'top',
                    toast: true,
                    timer: 4000,
                    showConfirmButton: false
                });
                return;
            }

            attempts.push(currentTime);
            localStorage.setItem('notifyAttempts', JSON.stringify(attempts));

            const appToken = "AT_8FQFDxpI2qvtDTrQG7jUCj6aTHOjgi2W";
            const secret = "your-secret-key"; // 替换为实际密钥
            const nonce = generateNonce();
            const timestamp = Date.now();
            const signature = generateSignature(appToken, nonce, timestamp, secret);

            fetch("https://wxpusher.zjiecode.com/api/send/message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    appToken,
                    content: "您好，有人需要您挪车，请及时处理。",
                    contentType: 1,
                    uids: ["UID_AIQ8tkck5ulReU0umP6rNfOJ10lw", "UID_AIQ8tkck5ulReU0umP6rNfOJ10lw1"],
                    nonce,
                    timestamp,
                    signature
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1000) {
                    Swal.fire({
                        icon: 'success',
                        title: '通知已发送！',
                        text: '车主已收到您的通知。',
                        position: 'top',
                        toast: true,
                        timer: 4000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '通知发送失败',
                        text: '请稍后重试。',
                        position: 'top',
                        toast: true,
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            })
            .catch(error => {
                console.error("Error sending notification:", error);
                Swal.fire({
                    icon: 'error',
                    title: '网络错误',
                    text: '通知发送出错，请检查网络连接。',
                    position: 'top',
                    toast: true,
                    timer: 3000,
                    showConfirmButton: false
                });
            });
        }

        function callOwner() {
            window.location.href = "tel:17896021990";
        }

        window.onload = function () {
            notifyButton.addEventListener('click', notifyOwner);
        };
    </script>
</body>
</html>
